#=========================================================
# Makefile ‚Äî Simulaci√≥n FSM (QuestaSim / Linux / Ubuntu)
# Autor: Miguel Alem√°n
#=========================================================

#-----------------------------------------
# Variables
#-----------------------------------------

# Herramientas del simulador (aseg√∫rate de que est√©n en tu PATH)
VLIB = vlib
VLOG = vlog
VSIM = vsim

# Directorios
RTL_DIR   = ../rtl
TB_DIR    = ../tb
WORK_LIB  = work
TOP       = tb
WAVE_DO   = wave.do

# Archivos fuente
RTL_SRCS  = $(RTL_DIR)/fsm.sv
TB_SRCS   = $(TB_DIR)/fsm_property.sv $(TB_DIR)/tb.sv
UCDB_FILE = fsm.ucdb

#-----------------------------------------
# Targets principales
#-----------------------------------------

# Por defecto: compila y simula en modo consola
all: compile simulate

#-----------------------------------------
# Compilaci√≥n
#-----------------------------------------
compile:
	@echo "========================================================="
	@echo "üîß Compilando fuentes RTL y Testbench..."
	@echo "========================================================="
	@rm -rf $(WORK_LIB)
	@$(VLIB) $(WORK_LIB)
	@$(VLOG) -cover bcest $(RTL_SRCS)
	@$(VLOG) $(TB_SRCS)
	@echo "‚úÖ Compilaci√≥n completada correctamente."

#-----------------------------------------
# Simulaci√≥n en modo consola
#-----------------------------------------
simulate:
	@echo "========================================================="
	@echo "üöÄ Ejecutando simulaci√≥n en modo consola..."
	@echo "========================================================="
	@$(VSIM) -c $(TOP) -do "run -all; coverage save $(UCDB_FILE); \
	vcover report $(UCDB_FILE); vcover report $(UCDB_FILE) -cvg -details; quit -f"
	@echo "‚úÖ Simulaci√≥n completada."

#-----------------------------------------
# Simulaci√≥n en modo gr√°fico (GUI)
#-----------------------------------------
gui:
	@echo "========================================================="
	@echo "üñ•Ô∏è Ejecutando simulaci√≥n en modo gr√°fico (GUI)..."
	@echo "========================================================="
	@$(VSIM) -gui $(TOP) -do "do $(WAVE_DO); run -all; \
	coverage save $(UCDB_FILE); \
	vcover report $(UCDB_FILE); \
	vcover report $(UCDB_FILE) -cvg -details;"
	@echo "‚úÖ Simulaci√≥n completada en GUI."

#-----------------------------------------
# Limpieza de archivos temporales
#-----------------------------------------
clean:
	@echo "========================================================="
	@echo "üßπ Limpiando archivos temporales y resultados..."
	@echo "========================================================="
	@rm -rf $(WORK_LIB) $(UCDB_FILE) transcript vsim.wlf vsim.dbg
	@echo "‚úÖ Limpieza completada."

#-----------------------------------------
# Ayuda
#-----------------------------------------
help:
	@echo "========================================================="
	@echo "üìò Opciones disponibles en el Makefile"
	@echo "========================================================="
	@echo "make all       ‚Üí Compila y simula en modo consola"
	@echo "make compile   ‚Üí Solo compila RTL y Testbench"
	@echo "make simulate  ‚Üí Ejecuta simulaci√≥n sin GUI"
	@echo "make gui       ‚Üí Ejecuta simulaci√≥n con GUI y wave.do"
	@echo "make clean     ‚Üí Elimina archivos temporales"
	@echo "make help      ‚Üí Muestra esta ayuda"
	@echo "========================================================="

